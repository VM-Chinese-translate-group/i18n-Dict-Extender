name: Update and Release Dictionary

on:
  workflow_dispatch:
  schedule:
    # 每周五 UTC 时间 10:00 执行 (北京时间 18:00)
    - cron: '0 10 * * 5'

permissions:
  contents: write
  issues: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('.github/scripts/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: pip install -r .github/scripts/requirements.txt

      - name: Run update script
        run: python .github/scripts/update_dictionary.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
      
      - name: Generate release info
        id: generate_info
        run: |
          echo "RELEASE_TAG=dict-update-$(date -u +'%Y-%m-%d-%H%M')" >> $GITHUB_ENV
          echo "RELEASE_NAME=自动词典更新 $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release_body.md
          files: |
            Dict.json
            Dict-Mini.json
            Dict-Sqlite.db
            diff.json

      - name: Create Issue on Failure
        # 条件判断：只有当 update_script 步骤的输出 update_failed 为 'true' 时才执行
        if: steps.update_script.outputs.update_failed == 'true'
        run: |
          gh issue create \
            --title "词典自动更新失败: $(date -u +'%Y-%m-%d')" \
            --body "你好，
            
            在仓库 **${{ github.repository }}** 中执行的 “Update and Release Dictionary” 工作流检测到部分词典源更新失败。

            失败详情已记录在最新的 Release 正文中，请点击下方链接查看：
            **${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}**

            你也可以直接查看本次工作流的运行日志来定位问题：
            **${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}**

            请及时检查失败原因并处理此 Issue。
            " \
            --label "bug,automation" \
            --assignee "maxinglo"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}